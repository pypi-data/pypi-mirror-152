#!python
# This file is placed in the Public Domain.


"irc bot"


import os
import sys


sys.path.insert(0, os.getcwd())


import logging
import readline
import termios
import time
import traceback


import bot


from bot.obj import Config, format


Config.name = "bot"
Config.threaded = False
Config.version = "160"
Config.workdir = os.path.expanduser("~/.bot")


from bot.csl import CLI, Console
from bot.hdl import Callbacks, Commands, dispatch
from bot.irc import IRC
from bot.rss import Fetcher


import bot.cmd.all


class CLI(CLI):

    def raw(self, txt):
        print(txt)


class Console(Console):

    def raw(self, txt):
        print(txt)


def isopt(opts):
    for o in opts:
        t = "-%s" % o
        if t in sys.argv:
            return True
    return False


def wrap(func):
    fd = sys.stdin.fileno()
    old = termios.tcgetattr(fd)
    try:
        func()
    except (EOFError, KeyboardInterrupt):
        print("")
    finally:
        termios.tcsetattr(fd, termios.TCSADRAIN, old)
        for err in Callbacks.errors:
            traceback.print_exception(type(err), err, err.__traceback__)


def main():
    Callbacks.add("command", dispatch)
    if len(sys.argv) > 1 and not isopt("ic"):
        c = CLI()
        return c.cmd(" ".join(sys.argv[1:]))
    if isopt("irc"):
        print("BOT started at %s" % (time.ctime(time.time()).replace("  ", " ")))
        print(format(Config, skip="password"))
    if isopt("t"):
        Config.threaded = True
    if isopt("v"):
        Config.verbose = True
    if isopt("i"):
        i = IRC()
        i.start()
        print(format(i.cfg, skip="password,realname,sleep,username"))
    if isopt("r"):
        f = Fetcher()
        f.start()
    if isopt("ic"):
        c = Console()
        c.start()
        c.forever()


wrap(main)
